# 操作系统

## 功能

1. **进程和线程的管理**：进程的创建、撤销、阻塞、唤醒，进程间的通信等。
2. **存储管理**：内存的分配和管理、外存（磁盘等）的分配和管理等。
3. **文件管理**：文件的读、写、创建及删除等。
4. **设备管理**：完成设备（输入输出设备和外部存储设备等）的请求或释放，以及设备启动等功能。
5. **网络管理**：操作系统负责管理计算机网络的使用。网络是计算机系统中连接不同计算机的方式，操作系统需要管理计算机网络的配置、连接、通信和安全等，以提供高效可靠的网络服务。
6. **安全管理**：用户的身份认证、访问控制、文件加密等，以防止非法用户对系统资源的访问和操作。

## 用户态和内核态

- **用户态(User Mode)**：用户态运行的进程可以直接读取用户程序的数据，拥有较低的权限，当应用程序需要执行某些特殊权限的操作，例如读写磁盘、网络通信等，就需要向操作系统发起系统调用请求，进入内核态。
- **内核态(Kernel Mode)**：内核态运行的进程几乎可以访问计算机的任何资源包括系统的内存空间、设备、驱动程序等，不受限制，拥有非常高的权限。当操作系统接收到进程的系统调用请求时，就会从用户态切换到内核态，执行相应的系统调用，并将结果返回给进程，最后再从内核态切换回用户态。

<img src="https://raw.githubusercontent.com/Moriic/picture/main/image/1711511059_0.png" alt="usermode-and-kernelmode" style="zoom: 67%;" />

### 为什么需要两个态

- 同时具有用户态和内核态主要是为了保证计算机系统的安全性、稳定性和性能。

- 如果计算机系统中只有一个内核态，那么所有程序或进程都必须共享系统资源，例如内存、CPU、硬盘等，这将导致系统资源的竞争和冲突，从而影响系统性能和效率。

### 切换方式

1. **系统调用(Trap)**：用户态进程主动切换到内核态，为了使用内核态才能做的事情，如读取磁盘资源。系统调用的机制其核心还是使用了中断
2. **中断(Interrupt)**：当外围设备完成用户请求的操作后，会向 CPU 发出相应的中断信号，CPU 会去执行要处理的程序，如果向前执行的指令是用户态下的程序，会切换到内核态，结束后切换会用户态
3. **异常(Exception)**：当 CPU 在执行运行在用户态的程序时，发生了异常，则会切换到处理该异常的内核态中，如缺页异常

## 系统调用

- 调用操作系统提供的内核态级别的功能(文件管理，进程控制，内存管理)
- 普通的库函数调用运行于用户态

### 过程

<img src="https://raw.githubusercontent.com/Moriic/picture/main/image/1711512021_0.png" alt="system-call-procedure" style="zoom: 67%;" />

1. 用户态程序发起系统调用，涉及内核态的指令，权限不足会中断执行 Trap
2. 发生中断后，CPU 程序会中断，跳转到中断处理程序，内核程序开始运行，处理系统调用
3. 系统调用处理完后，主动触发 Trap，再次发生中断，切换到用户态

## 进程和线程

- 进程(Process)：计算机正在运行的一个程序实例，如打开的微信
- 线程(Thread)：轻量级进程，多个线程可以在一个进程中同时执行，并且共享进程的资源如内存空间，文件句柄，网路连接等，如微信中有个线程专门拉取消息

### 区别

一个进程中可以有多个线程，多个线程共享进程的 **堆** 和 **方法区**(JDK1.8 之后的元空间)资源，但是每个线程有自己的 **程序计数器**、**虚拟机栈** 和 **本地方法栈**。

- **线程是进程划分成的更小的运行单位**，一个进程在其执行过程可以产生多个线程
- 线程和进程**最大的不同在于各进程是独立的，而线程不一定，可能会相互影响**
- **线程执行开销小**，当不利于资源管理和保护

### 为什么需要线程

- **进程切换是个开销很大的操作，线程切换成本较低**
- 线程更轻量，一个进程可以创建多个线程
- 多个线程可以 **并发处理多个任务，** 有效利用了多处理器和多核计算机，而进程只能干一件事，**遇到 IO 等阻塞就会挂起**
- 同一进程内的 **线程共享内存和文件**，因此他们之间通信 **无需调用内核**

### 同步方式

1. 互斥锁(Mutex)：采用互斥对象机制，只有拥有互斥对象的线程才有访问公共资源的权限，因为互斥对象只有一个，所以可以保证
2. 
